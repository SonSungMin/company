<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ AI ìê²©ì¦ CBT (V8 - Multi Select)</title>
    <style>
        :root {
            --primary: #03C75A;
            --secondary: #4a6fa5;
            --danger: #ff6b6b;
            --warning: #fcc419;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #333;
            --select-bg: #e8f8f0;
        }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
        }
        .container { width: 100%; max-width: 800px; }
        .box {
            background: var(--card); padding: 25px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        h1 { text-align: center; color: var(--primary); margin: 0 0 20px 0; }
        
        /* ë²„íŠ¼ */
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 20px; font-size: 1rem; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { filter: brightness(0.9); }
        .btn-outline { background: #fff; border: 1px solid #ddd; color: #555; }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); color: #333; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        
        /* ì…ë ¥ì°½ & ì„¤ì • */
        textarea {
            width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd;
            border-radius: 8px; resize: vertical; box-sizing: border-box; font-family: monospace;
        }
        .settings-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;
            background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee;
        }
        input[type="number"] {
            padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; text-align: center;
        }
        
        /* íŒŒì¼ ë¶„ì„ */
        #file-analysis {
            background: #e8f8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid #c3e6cb; font-size: 0.9rem;
        }
        #section-list {
            list-style: none; padding: 0; margin: 5px 0 0 0;
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        #section-list li {
            background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 4px;
        }

        /* í€´ì¦ˆ UI */
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px;
        }
        .timer-box { font-size: 1.1rem; font-weight: bold; color: var(--danger); }
        .section-badge {
            display: inline-block; background-color: var(--secondary); color: white;
            padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .q-text { font-size: 1.25rem; font-weight: bold; margin-bottom: 20px; word-break: keep-all; line-height: 1.5; }
        
        /* ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .option-item {
            background: #fff; border: 2px solid #eee; padding: 15px;
            border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center;
        }
        .option-item:hover { background: #fafafa; border-color: #ccc; }
        
        /* ì„ íƒëœ ìƒíƒœ (ë‹¤ì¤‘ ì„ íƒ ì‹œ) */
        .option-item.selected {
            background-color: var(--select-bg); border-color: var(--primary);
            box-shadow: inset 0 0 0 1px var(--primary);
        }
        
        /* ì •ë‹µ/ì˜¤ë‹µ ê²°ê³¼ */
        .option-item.correct { background: #e6fcf5; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .option-item.wrong { background: #fff5f5; border-color: var(--danger); color: var(--danger); }
        .option-item.missed { border: 2px dashed var(--primary); } /* ì •ë‹µì¸ë° ì„ íƒ ì•ˆ í•œ ê²ƒ */

        .check-btn-area { text-align: center; margin-top: 15px; }
        
        .explanation {
            display: none; background: #f8f9fa; padding: 15px;
            border-radius: 8px; border-left: 5px solid var(--primary); margin-top: 20px;
        }
        .explanation.show { display: block; }
        .hidden { display: none; }

        /* ê²°ê³¼ í™”ë©´ */
        .result-badge {
            display: inline-block; padding: 10px 30px; border-radius: 50px;
            font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: white;
        }
        .pass { background-color: var(--primary); }
        .fail { background-color: var(--danger); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border-bottom: 1px solid #eee; text-align: center; font-size: 0.9rem; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen" class="box">
        <h1>ğŸ“ ë„¤ì´ë²„ AI ìê²©ì¦ CBT</h1>
        
        <textarea id="data-input" placeholder="ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.&#13;&#10;(## ì„¹ì…˜ëª…, ë³µìˆ˜ ì •ë‹µ ì§€ì›)"></textarea>
        
        <div style="text-align:right; margin-bottom:15px;">
            <input type="file" id="file-input" accept=".txt" style="display:none">
            <button class="btn btn-outline" onclick="document.getElementById('file-input').click()" style="font-size:0.9rem;">ğŸ“‚ í…ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>

        <div id="file-analysis" class="hidden">
            <strong>ğŸ“Š íŒŒì¼ ë¶„ì„ ê²°ê³¼ (ì„¹ì…˜ ê·¸ë£¹í•‘ ì™„ë£Œ)</strong>
            <div style="font-size:0.85rem; color:#666; margin-bottom:5px;">ì´ <span id="total-analysis-count">0</span>ë¬¸ì œ</div>
            <ul id="section-list"></ul>
        </div>

        <div class="settings-grid">
            <div><label>â±ï¸ ì œí•œ ì‹œê°„ (ë¶„)</label><input type="number" id="timer-input" value="60" min="1"></div>
            <div><label>ğŸ“ ì¶œì œ ë¬¸í•­ ìˆ˜</label><input type="number" id="q-count-input" value="60" min="1"></div>
        </div>

        <button class="btn" style="width:100%; font-size:1.1rem;" onclick="startQuiz()">ì‹œí—˜ ì‹œì‘í•˜ê¸° ğŸš€</button>
        
        </div>

    <div id="quiz-screen" class="box hidden">
        <div class="quiz-header">
            <div class="timer-box">
                <span id="timer-display">60:00</span>
                <button class="btn btn-outline" style="padding: 2px 8px; font-size: 0.7rem; margin-left:5px;" onclick="togglePause()" id="btn-pause">ì¼ì‹œì •ì§€</button>
            </div>
            <div>
                <span style="font-weight:bold; color:var(--primary)">Score: <span id="current-score">0</span></span>
                <span style="color:#999; margin-left:10px; font-size:0.9rem;" id="q-progress">1/N</span>
            </div>
        </div>

        <div id="q-container">
            <div id="section-badge" class="section-badge hidden">ì„¹ì…˜ëª…</div>
            <div class="q-text" id="q-text">ë¬¸ì œ...</div>
            
            <div id="options-area"></div>
            
            <div id="check-btn-area" class="check-btn-area hidden">
                <button class="btn btn-sm" onclick="submitMultiAnswer()">ì •ë‹µ í™•ì¸</button>
            </div>

            <div class="explanation" id="expl-area">
                <strong>ğŸ’¡ í•´ì„¤</strong><br><span id="expl-text"></span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:30px;">
            <button class="btn btn-outline" onclick="prevQ()">ì´ì „</button>
            <button class="btn" onclick="nextQ()" id="btn-next">ë‹¤ìŒ ë¬¸ì œ</button>
            <button class="btn btn-danger" onclick="finishQuiz()">ì œì¶œí•˜ê¸°</button>
        </div>
    </div>

    <div id="result-screen" class="box hidden">
        <h2 style="text-align:center;">ì‹œí—˜ ê²°ê³¼</h2>
        <div style="text-align:center; margin-bottom:20px;">
            <div id="pass-fail-badge" class="result-badge pass">í•©ê²©</div>
            <div style="font-size:3rem; color:#333; font-weight:bold;"><span id="final-score">0</span>ì </div>
            <p>ì´ <span id="total-q-count">0</span>ë¬¸ì œ ì¤‘ <span id="correct-count">0</span>ê°œ ì •ë‹µ</p>
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn btn-warning" id="btn-retry-wrong" onclick="retryWrong()">âŒ ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°</button>
            <button class="btn btn-outline" onclick="location.reload()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<script>
    let allQuestions = [];
    let quizList = [];
    let currentIdx = 0;
    let score = 0;
    let userHistory = {}; // { qId: { selected: [indices], isCorrect: bool } }
    let timerInterval = null;
    let timeRemaining = 0;
    let isPaused = false;
    let isReviewMode = false;
    
    // í˜„ì¬ ë¬¸ì œì˜ ì •ë‹µ ì¸ë±ìŠ¤ë“¤ (ë¡œë”© ì‹œ ê°±ì‹ )
    let currentCorrectIndices = [];

    // íŒŒì¼ ì½ê¸°
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('data-input').value = e.target.result;
            const tempQs = parseQuestions(e.target.result);
            analyzeAndDisplayFile(tempQs);
        };
        reader.readAsText(file, 'UTF-8');
    });

    // íŒŒì‹± (ì •ë‹µ ë¬¸ìì—´ì—ì„œ ìˆ«ì/ê¸°í˜¸ ì¶”ì¶œ)
    function parseQuestions(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
        const parsed = [];
        let currentQ = null;
        let currentSection = "ì¼ë°˜";

        lines.forEach(line => {
            if (line.startsWith('##')) {
                currentSection = line.replace(/^##\s*/, '').trim();
                return;
            }
            const qMatch = line.match(/^(\*\*)?(\d+)\.(.*)/);
            if (qMatch) {
                if (currentQ) parsed.push(currentQ);
                let qContent = line.replace(/^(\*\*)?\d+\./, '').trim().replace(/\*\*$/, '');
                currentQ = {
                    id: parsed.length, q: qContent, o: [], aString: '', aIndices: [], e: '', section: currentSection
                };
            } else if (currentQ) {
                if (line.match(/^[â‘ â‘¡â‘¢â‘£â‘¤1-5]/)) {
                    currentQ.o.push(line);
                } else if (line.match(/^(\*\*)?ì •ë‹µ[:\s]/)) {
                    // ì •ë‹µ íŒŒì‹± ë¡œì§ ê°•í™”
                    let raw = line.replace(/^(\*\*)?ì •ë‹µ[:\s]*/, '').replace(/\*\*/g, '').trim();
                    currentQ.aString = raw;
                    currentQ.aIndices = getIndicesFromStr(raw); // [0, 1] í˜•íƒœì˜ ì¸ë±ìŠ¤ë¡œ ë³€í™˜
                } else if (line.startsWith('í•´ì„¤:')) {
                    currentQ.e = line.replace('í•´ì„¤:', '').trim();
                }
            }
        });
        if (currentQ) parsed.push(currentQ);
        return parsed;
    }

    // ì •ë‹µ ë¬¸ìì—´ -> ì¸ë±ìŠ¤ ë°°ì—´ ë³€í™˜ (â‘ ->0, 1->0)
    function getIndicesFromStr(str) {
        const map = {'â‘ ':0, 'â‘¡':1, 'â‘¢':2, 'â‘£':3, 'â‘¤':4, '1':0, '2':1, '3':2, '4':3, '5':4};
        const matches = str.match(/[â‘ â‘¡â‘¢â‘£â‘¤1-5]/g) || [];
        // ì¤‘ë³µ ì œê±° ë° ë§¤í•‘
        const indices = [...new Set(matches.map(m => map[m]).filter(i => i !== undefined))];
        return indices.sort((a,b)=>a-b);
    }

    // íŒŒì¼ ë¶„ì„ ë° ì„¹ì…˜ ê·¸ë£¹í•‘ ì¤€ë¹„
    function analyzeAndDisplayFile(questions) {
        if (questions.length === 0) return alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        // ì„¹ì…˜ ì¹´ìš´íŠ¸
        const sectionStats = {};
        const sectionOrder = [];
        questions.forEach(q => {
            if (!sectionStats[q.section]) {
                sectionStats[q.section] = 0;
                sectionOrder.push(q.section);
            }
            sectionStats[q.section]++;
        });

        // UI í‘œì‹œ
        document.getElementById('file-analysis').classList.remove('hidden');
        document.getElementById('total-analysis-count').innerText = questions.length;
        const ul = document.getElementById('section-list');
        ul.innerHTML = '';
        sectionOrder.forEach(sec => {
            const li = document.createElement('li');
            li.innerText = `${sec}: ${sectionStats[sec]}ë¬¸ì œ`;
            ul.appendChild(li);
        });

        // ê¸°ë³¸ê°’ ìë™ ì„¸íŒ…
        document.getElementById('timer-input').value = 60;
        document.getElementById('q-count-input').value = Math.min(60, questions.length);
        alert(`ë¡œë“œ ì™„ë£Œ! ${questions.length}ë¬¸ì œ, ${sectionOrder.length}ê°œ ì„¹ì…˜.`);
    }

    // í€´ì¦ˆ ìƒì„± (ì„¹ì…˜ ê·¸ë£¹í•‘ í•µì‹¬ ë¡œì§)
    function generateQuizList(questions, targetCount) {
        // 1. ì„¹ì…˜ë³„ë¡œ ë¶„ë¥˜ (ìˆœì„œ ìœ ì§€ë¥¼ ìœ„í•´ Map ì‚¬ìš©)
        const sectionMap = new Map(); // Key: SectionName, Value: Array
        questions.forEach(q => {
            if (!sectionMap.has(q.section)) sectionMap.set(q.section, []);
            sectionMap.get(q.section).push(q);
        });

        const distinctSections = Array.from(sectionMap.keys());
        if (targetCount >= questions.length) {
            // ì „ì²´ ë¬¸ì œë©´, ì„¹ì…˜ ìˆœì„œëŒ€ë¡œ ì­‰ ì´ì–´ë¶™ì—¬ì„œ ë¦¬í„´ (ìë™ ê·¸ë£¹í•‘ íš¨ê³¼)
            let result = [];
            distinctSections.forEach(sec => {
                result = result.concat(sectionMap.get(sec)); // ë‚´ë¶€ ìˆœì„œëŠ” ê·¸ëŒ€ë¡œ ë‘˜ì§€ ì„ì„ì§€? -> ë³´í†µ ì„¹ì…˜ ë‚´ ë¬¸ì œëŠ” ì„ëŠ” ê²Œ ì¢‹ìŒ
            });
            return result;
        }

        // ë¬¸í•­ ìˆ˜ ì¡°ì ˆì´ í•„ìš”í•œ ê²½ìš° ê· ë“± ë¶„ë°°
        let result = [];
        const baseCount = Math.floor(targetCount / distinctSections.length);
        let remainder = targetCount % distinctSections.length;

        distinctSections.forEach(sec => {
            let count = baseCount + (remainder > 0 ? 1 : 0);
            if (remainder > 0) remainder--;
            
            const pool = sectionMap.get(sec);
            // ì„¹ì…˜ ë‚´ì—ì„œ ëœë¤ ì¶”ì¶œ
            const picked = pool.sort(() => Math.random() - 0.5).slice(0, Math.min(count, pool.length));
            result = result.concat(picked);
        });
        
        return result;
    }

    function startQuiz() {
        const rawText = document.getElementById('data-input').value;
        if (!rawText.trim()) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        allQuestions = parseQuestions(rawText);
        
        const inputCount = parseInt(document.getElementById('q-count-input').value);
        const targetCount = (inputCount > 0) ? inputCount : allQuestions.length;
        
        quizList = generateQuizList(allQuestions, targetCount);
        
        userHistory = {};
        score = 0;
        currentIdx = 0;
        isReviewMode = false;
        
        const mins = parseInt(document.getElementById('timer-input').value) || 60;
        timeRemaining = mins * 60;
        startTimer();

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        
        loadQuestion(0);
    }

    function loadQuestion(idx) {
        currentIdx = idx;
        const qData = quizList[idx];
        currentCorrectIndices = qData.aIndices;

        // UI ì´ˆê¸°í™”
        document.getElementById('q-progress').innerText = `${idx + 1} / ${quizList.length}`;
        document.getElementById('current-score').innerText = score;
        
        const badge = document.getElementById('section-badge');
        if (qData.section !== "ì¼ë°˜") { badge.innerText = qData.section; badge.classList.remove('hidden'); }
        else badge.classList.add('hidden');

        document.getElementById('q-text').innerText = `Q. ${qData.q}`;
        document.getElementById('expl-area').classList.remove('show');
        
        const optsArea = document.getElementById('options-area');
        optsArea.innerHTML = '';
        
        // ì •ë‹µ ê°œìˆ˜ì— ë”°ë¼ ëª¨ë“œ ê²°ì •
        const isMulti = currentCorrectIndices.length > 1;
        document.getElementById('check-btn-area').classList.toggle('hidden', !isMulti);

        qData.o.forEach((optText, i) => {
            const btn = document.createElement('div');
            btn.className = 'option-item';
            btn.innerText = optText;
            btn.dataset.idx = i;
            
            if (userHistory[qData.id]) {
                // ì´ë¯¸ í‘¼ ë¬¸ì œ: ê²°ê³¼ í‘œì‹œ
                btn.style.pointerEvents = 'none';
                const record = userHistory[qData.id];
                
                // ë‚´ê°€ ì„ íƒí–ˆëŠ”ì§€ í™•ì¸
                if (record.selected.includes(i)) {
                    // ë§ì•˜ìœ¼ë©´ correct, í‹€ë ¸ìœ¼ë©´ wrong
                    // ë¶€ë¶„ì ìˆ˜ ì—†ìŒ: ì „ì²´ ì •ë‹µ ì„¸íŠ¸ì™€ ë¹„êµí•´ì•¼ í•¨
                    if (currentCorrectIndices.includes(i)) btn.classList.add('correct');
                    else btn.classList.add('wrong');
                }
                // ì •ë‹µì¸ë° ì„ íƒ ì•ˆ í•œ ê²ƒ í‘œì‹œ
                if (currentCorrectIndices.includes(i) && !record.selected.includes(i)) {
                    btn.classList.add('missed');
                }
            } else {
                // ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œ
                btn.onclick = () => handleOptionClick(i, btn, isMulti);
            }
            optsArea.appendChild(btn);
        });

        if (userHistory[qData.id]) {
            document.getElementById('expl-text').innerText = qData.e || "í•´ì„¤ ì—†ìŒ";
            document.getElementById('expl-area').classList.add('show');
            if (isMulti) document.getElementById('check-btn-area').classList.add('hidden'); // ì´ë¯¸ í’€ì—ˆìœ¼ë‹ˆ ë²„íŠ¼ ìˆ¨ê¹€
        }
    }

    // ë³´ê¸° í´ë¦­ í•¸ë“¤ëŸ¬
    function handleOptionClick(idx, btn, isMulti) {
        if (isMulti) {
            // ë³µìˆ˜ ì •ë‹µ: ì„ íƒ ìƒíƒœ í† ê¸€ (ì±„ì  X)
            btn.classList.toggle('selected');
        } else {
            // ë‹¨ì¼ ì •ë‹µ: ì¦‰ì‹œ ì±„ì 
            submitSingleAnswer(idx);
        }
    }

    // ë‹¨ì¼ ì •ë‹µ ì œì¶œ ì²˜ë¦¬
    function submitSingleAnswer(selectedIdx) {
        const qData = quizList[currentIdx];
        const isCorrect = (qData.aIndices.length === 1 && qData.aIndices[0] === selectedIdx);
        
        finishQuestion([selectedIdx], isCorrect);
    }

    // ë³µìˆ˜ ì •ë‹µ ì œì¶œ ì²˜ë¦¬
    function submitMultiAnswer() {
        const selectedBtns = document.querySelectorAll('.option-item.selected');
        if (selectedBtns.length === 0) return alert("í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const selectedIndices = Array.from(selectedBtns).map(b => parseInt(b.dataset.idx)).sort((a,b)=>a-b);
        const qData = quizList[currentIdx];

        // ì •ë‹µ ë¹„êµ (ë°°ì—´ ë‚´ìš©ë¬¼ì´ ê°™ì•„ì•¼ í•¨)
        const isCorrect = JSON.stringify(selectedIndices) === JSON.stringify(qData.aIndices);
        
        finishQuestion(selectedIndices, isCorrect);
    }

    // ë¬¸ì œ ì¢…ë£Œ ê³µí†µ ì²˜ë¦¬
    function finishQuestion(selectedIndices, isCorrect) {
        const qData = quizList[currentIdx];
        
        // ê¸°ë¡ ì €ì¥
        userHistory[qData.id] = { selected: selectedIndices, isCorrect: isCorrect };
        if (isCorrect) score++;

        // UI ì—…ë°ì´íŠ¸ (ì •ë‹µ/ì˜¤ë‹µ í‘œì‹œ)
        const buttons = document.querySelectorAll('.option-item');
        buttons.forEach((btn, i) => {
            btn.style.pointerEvents = 'none'; // í´ë¦­ ë§‰ê¸°
            btn.classList.remove('selected'); // ì„ íƒ ìŠ¤íƒ€ì¼ ì œê±° í›„ ê²°ê³¼ ìŠ¤íƒ€ì¼ ì ìš©
            
            if (selectedIndices.includes(i)) {
                if (qData.aIndices.includes(i)) btn.classList.add('correct');
                else btn.classList.add('wrong');
            }
            if (qData.aIndices.includes(i) && !selectedIndices.includes(i)) {
                btn.classList.add('missed');
            }
        });

        // ì ìˆ˜ ê°±ì‹  ë° í•´ì„¤ í‘œì‹œ
        document.getElementById('current-score').innerText = score;
        document.getElementById('expl-text').innerText = qData.e || "í•´ì„¤ ì—†ìŒ";
        document.getElementById('expl-area').classList.add('show');
        document.getElementById('check-btn-area').classList.add('hidden');
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        const total = quizList.length;
        const finalScore = Math.round((score / total) * 100) || 0;
        const isPass = finalScore >= 60;

        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        
        document.getElementById('final-score').innerText = finalScore;
        document.getElementById('total-q-count').innerText = total;
        document.getElementById('correct-count').innerText = score;
        
        const badge = document.getElementById('pass-fail-badge');
        badge.innerText = isPass ? "ğŸ‰ í•©ê²©" : "ğŸ˜¢ ë¶ˆí•©ê²©";
        badge.className = `result-badge ${isPass ? 'pass' : 'fail'}`;

        const retryBtn = document.getElementById('btn-retry-wrong');
        retryBtn.style.display = (total - score > 0) ? 'inline-block' : 'none';
    }

    function retryWrong() {
        const wrongQs = quizList.filter(q => userHistory[q.id] && !userHistory[q.id].isCorrect);
        if (wrongQs.length === 0) return alert("ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");

        quizList = wrongQs;
        userHistory = {};
        score = 0;
        currentIdx = 0;
        isReviewMode = true;

        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        loadQuestion(0);
    }

    function startTimer() {
        clearInterval(timerInterval);
        isPaused = false;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("ì‹œê°„ ì¢…ë£Œ!");
                    finishQuiz();
                }
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        document.getElementById('timer-display').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function togglePause() { isPaused = !isPaused; document.getElementById('btn-pause').innerText = isPaused ? "ê³„ì†" : "ì¼ì‹œì •ì§€"; document.getElementById('q-container').style.opacity = isPaused ? '0.2' : '1'; document.getElementById('q-container').style.pointerEvents = isPaused ? 'none' : 'auto'; }
    function nextQ() { if (currentIdx < quizList.length - 1) loadQuestion(currentIdx + 1); else if(confirm("ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) finishQuiz(); }
    function prevQ() { if (currentIdx > 0) loadQuestion(currentIdx - 1); }
</script>
</body>
</html>
