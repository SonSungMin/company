<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤ì´ë²„ AI ìê²©ì¦ CBT (V9 - Pro)</title>
    <style>
        :root {
            --primary: #03C75A;
            --secondary: #4a6fa5;
            --danger: #ff6b6b;
            --warning: #fcc419;
            --bg: #f4f6f8;
            --card: #ffffff;
            --text: #333;
            --select-bg: #e8f8f0;
        }
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
            display: flex; justify-content: center;
        }
        .container { width: 100%; max-width: 800px; }
        .box {
            background: var(--card); padding: 25px; border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px;
        }
        h1 { text-align: center; color: var(--primary); margin: 0 0 20px 0; }
        
        /* ë²„íŠ¼ */
        .btn {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 20px; font-size: 1rem; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn:hover { filter: brightness(0.9); }
        .btn-outline { background: #fff; border: 1px solid #ddd; color: #555; }
        .btn-danger { background-color: var(--danger); }
        .btn-warning { background-color: var(--warning); color: #333; }
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; }
        
        /* ì…ë ¥ì°½ & ì„¤ì • */
        textarea {
            width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd;
            border-radius: 8px; resize: vertical; box-sizing: border-box; font-family: monospace;
        }
        .settings-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;
            background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee;
        }
        input[type="number"] {
            padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; box-sizing: border-box; text-align: center;
        }
        
        /* íŒŒì¼ ë¶„ì„ */
        #file-analysis {
            background: #e8f8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px;
            border: 1px solid #c3e6cb; font-size: 0.9rem;
        }
        #section-list {
            list-style: none; padding: 0; margin: 5px 0 0 0;
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        #section-list li {
            background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 4px;
        }

        /* í†µê³„ ë°” (New) */
        .stats-bar {
            background-color: #eef1f4; padding: 10px 15px; border-radius: 8px;
            margin-bottom: 20px; font-size: 0.9rem; color: #555;
            display: flex; justify-content: space-between; align-items: center;
        }
        .badge-correct { color: var(--primary); font-weight: bold; }
        .badge-wrong { color: var(--danger); font-weight: bold; }

        /* í€´ì¦ˆ UI */
        .quiz-header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 15px; border-bottom: 1px solid #eee; margin-bottom: 15px;
        }
        .timer-box { font-size: 1.1rem; font-weight: bold; color: var(--danger); }
        .section-badge {
            display: inline-block; background-color: var(--secondary); color: white;
            padding: 5px 15px; border-radius: 20px; font-size: 0.9rem; font-weight: bold;
            margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .q-text { font-size: 1.25rem; font-weight: bold; margin-bottom: 20px; word-break: keep-all; line-height: 1.5; }
        
        /* ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .option-item {
            background: #fff; border: 2px solid #eee; padding: 15px;
            border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center;
        }
        .option-item:hover { background: #fafafa; border-color: #ccc; }
        
        /* ì„ íƒëœ ìƒíƒœ */
        .option-item.selected {
            background-color: var(--select-bg); border-color: var(--primary);
            box-shadow: inset 0 0 0 1px var(--primary);
        }
        
        /* ì •ë‹µ/ì˜¤ë‹µ ê²°ê³¼ */
        .option-item.correct { background: #e6fcf5; border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .option-item.wrong { background: #fff5f5; border-color: var(--danger); color: var(--danger); }
        .option-item.missed { border: 2px dashed var(--primary); }

        .check-btn-area { text-align: center; margin-top: 15px; }
        
        .explanation {
            display: none; background: #f8f9fa; padding: 15px;
            border-radius: 8px; border-left: 5px solid var(--primary); margin-top: 20px;
        }
        .explanation.show { display: block; }
        .hidden { display: none; }

        /* ê²°ê³¼ í™”ë©´ */
        .result-badge {
            display: inline-block; padding: 10px 30px; border-radius: 50px;
            font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: white;
        }
        .pass { background-color: var(--primary); }
        .fail { background-color: var(--danger); }
        
        /* ê¸°ë¡ ëª¨ë‹¬ */
        .history-list {
            max-height: 300px; overflow-y: auto; text-align: left;
            border-top: 1px solid #eee; margin-top: 10px;
        }
        .history-item {
            padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9rem;
            display: flex; justify-content: space-between;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen" class="box">
        <h1>ğŸ“ ë„¤ì´ë²„ AI ìê²©ì¦ CBT</h1>
        
        <textarea id="data-input" placeholder="ë¬¸ì œ í…ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.&#13;&#10;(## ì„¹ì…˜ëª…, ë³µìˆ˜ ì •ë‹µ ì§€ì›)"></textarea>
        
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <div>
                <input type="file" id="file-input" accept=".txt" style="display:none">
                <button class="btn btn-outline btn-sm" onclick="document.getElementById('file-input').click()">ğŸ“‚ í…ìŠ¤íŠ¸ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
            <button class="btn btn-outline btn-sm" onclick="showExamHistory()">ğŸ“Š ë‚˜ì˜ ì‹œí—˜ ê¸°ë¡ ë³´ê¸°</button>
        </div>

        <div id="file-analysis" class="hidden">
            <strong>ğŸ“Š íŒŒì¼ ë¶„ì„ ê²°ê³¼</strong>
            <div style="font-size:0.85rem; color:#666; margin-bottom:5px;">ì´ <span id="total-analysis-count">0</span>ë¬¸ì œ</div>
            <ul id="section-list"></ul>
        </div>

        <div class="settings-grid">
            <div><label>â±ï¸ ì œí•œ ì‹œê°„ (ë¶„)</label><input type="number" id="timer-input" value="60" min="1"></div>
            <div><label>ğŸ“ ì¶œì œ ë¬¸í•­ ìˆ˜</label><input type="number" id="q-count-input" value="60" min="1"></div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:flex; align-items:center; cursor:pointer;">
                <input type="checkbox" id="shuffle-options-check" checked style="width:auto; margin-right:10px;">
                ì„ íƒì§€ ìˆœì„œ ëœë¤ ì„ê¸° (ì•”ê¸° ë°©ì§€)
            </label>
        </div>

        <button class="btn" style="width:100%; font-size:1.1rem;" onclick="startQuiz()">ì‹œí—˜ ì‹œì‘í•˜ê¸° ğŸš€</button>
        
        <div style="text-align:right; margin-top:10px;">
             <a href="#" onclick="clearAllData()" style="font-size:0.8rem; color:#999; text-decoration:underline;">ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</a>
        </div>
    </div>

    <div id="history-screen" class="box hidden">
        <h2>ğŸ“Š ë‚˜ì˜ ì‹œí—˜ ê¸°ë¡</h2>
        <div class="history-list" id="exam-log-list">
            </div>
        <div style="margin-top:20px; text-align:center;">
            <button class="btn btn-outline" onclick="closeExamHistory()">ë‹«ê¸°</button>
        </div>
    </div>

    <div id="quiz-screen" class="box hidden">
        <div class="quiz-header">
            <div class="timer-box">
                <span id="timer-display">60:00</span>
                <button class="btn btn-outline" style="padding: 2px 8px; font-size: 0.7rem; margin-left:5px;" onclick="togglePause()" id="btn-pause">ì¼ì‹œì •ì§€</button>
            </div>
            <div>
                <span style="font-weight:bold; color:var(--primary)">Score: <span id="current-score">0</span></span>
                <span style="color:#999; margin-left:10px; font-size:0.9rem;" id="q-progress">1/N</span>
            </div>
        </div>

        <div id="q-container">
            <div class="stats-bar">
                <span id="stat-result">ì´ì „ ê¸°ë¡: ì—†ìŒ</span>
                <span id="stat-count">ëˆ„ì  í’€ì´: 0íšŒ</span>
            </div>

            <div id="section-badge" class="section-badge hidden">ì„¹ì…˜ëª…</div>
            <div class="q-text" id="q-text">ë¬¸ì œ...</div>
            
            <div id="options-area"></div>
            
            <div id="check-btn-area" class="check-btn-area hidden">
                <button class="btn btn-sm" onclick="submitMultiAnswer()">ì •ë‹µ í™•ì¸</button>
            </div>

            <div class="explanation" id="expl-area">
                <strong>ğŸ’¡ í•´ì„¤</strong><br><span id="expl-text"></span>
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:30px;">
            <button class="btn btn-outline" onclick="prevQ()">ì´ì „</button>
            <button class="btn" onclick="nextQ()" id="btn-next">ë‹¤ìŒ ë¬¸ì œ</button>
            <button class="btn btn-danger" onclick="finishQuiz()">ì œì¶œí•˜ê¸°</button>
        </div>
    </div>

    <div id="result-screen" class="box hidden">
        <h2 style="text-align:center;">ì‹œí—˜ ê²°ê³¼</h2>
        <div style="text-align:center; margin-bottom:20px;">
            <div id="pass-fail-badge" class="result-badge pass">í•©ê²©</div>
            <div style="font-size:3rem; color:#333; font-weight:bold;"><span id="final-score">0</span>ì </div>
            <p>ì´ <span id="total-q-count">0</span>ë¬¸ì œ ì¤‘ <span id="correct-count">0</span>ê°œ ì •ë‹µ</p>
        </div>
        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
            <button class="btn btn-warning" id="btn-retry-wrong" onclick="retryWrong()">âŒ ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°</button>
            <button class="btn btn-outline" onclick="location.reload()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>
</div>

<script>
    // --- Global Variables ---
    let allQuestions = [];
    let quizList = [];
    let currentIdx = 0;
    let score = 0;
    let userHistory = {}; // ì´ë²ˆ ì„¸ì…˜ì˜ í’€ì´ ê¸°ë¡
    let timerInterval = null;
    let timeRemaining = 0;
    let isPaused = false;
    
    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
    const STORAGE_KEY_STATS = 'quiz_q_stats_v2'; // ë¬¸ì œë³„ í†µê³„
    const STORAGE_KEY_EXAMS = 'quiz_exam_log_v2'; // ì‹œí—˜ ê²°ê³¼ ëª©ë¡

    // --- Helper Functions ---
    // ê°„ë‹¨í•œ ë¬¸ìì—´ í•´ì‹œ ìƒì„± (ë¬¸ì œ IDìš©)
    function generateHash(str) {
        let hash = 0, i, chr;
        if (str.length === 0) return hash;
        for (i = 0; i < str.length; i++) {
            chr = str.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }
        return "q_" + Math.abs(hash);
    }

    function shuffleArray(array) {
        let shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    function loadStorage(key) {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : (key === STORAGE_KEY_EXAMS ? [] : {});
    }

    function saveStorage(key, data) {
        localStorage.setItem(key, JSON.stringify(data));
    }

    // --- File & Parse ---
    document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('data-input').value = e.target.result;
            const tempQs = parseQuestions(e.target.result);
            analyzeAndDisplayFile(tempQs);
        };
        reader.readAsText(file, 'UTF-8');
    });

    function parseQuestions(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
        const parsed = [];
        let currentQ = null;
        let currentSection = "ì¼ë°˜";

        lines.forEach(line => {
            if (line.startsWith('##')) {
                currentSection = line.replace(/^##\s*/, '').trim();
                return;
            }
            const qMatch = line.match(/^(\*\*)?(\d+)\.(.*)/);
            if (qMatch) {
                if (currentQ) parsed.push(currentQ);
                let qContent = line.replace(/^(\*\*)?\d+\./, '').trim().replace(/\*\*$/, '');
                // IDë¥¼ í…ìŠ¤íŠ¸ í•´ì‹œ ê¸°ë°˜ìœ¼ë¡œ ìƒì„±í•˜ì—¬ íŒŒì¼ì´ ìˆ˜ì •ë˜ì–´ë„ ë¬¸ì œ ë‚´ìš©ì´ ê°™ìœ¼ë©´ ì´ë ¥ ìœ ì§€
                currentQ = {
                    id: generateHash(qContent), 
                    q: qContent, 
                    o: [], 
                    aIndices: [], 
                    e: '', 
                    section: currentSection
                };
            } else if (currentQ) {
                if (line.match(/^[â‘ â‘¡â‘¢â‘£â‘¤1-5]/)) {
                    currentQ.o.push(line);
                } else if (line.match(/^(\*\*)?ì •ë‹µ[:\s]/)) {
                    let raw = line.replace(/^(\*\*)?ì •ë‹µ[:\s]*/, '').replace(/\*\*/g, '').trim();
                    currentQ.aIndices = getIndicesFromStr(raw);
                } else if (line.startsWith('í•´ì„¤:')) {
                    currentQ.e = line.replace('í•´ì„¤:', '').trim();
                }
            }
        });
        if (currentQ) parsed.push(currentQ);
        return parsed;
    }

    function getIndicesFromStr(str) {
        const map = {'â‘ ':0, 'â‘¡':1, 'â‘¢':2, 'â‘£':3, 'â‘¤':4, '1':0, '2':1, '3':2, '4':3, '5':4};
        const matches = str.match(/[â‘ â‘¡â‘¢â‘£â‘¤1-5]/g) || [];
        const indices = [...new Set(matches.map(m => map[m]).filter(i => i !== undefined))];
        return indices.sort((a,b)=>a-b);
    }

    function analyzeAndDisplayFile(questions) {
        if (questions.length === 0) return alert("ë¬¸ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        
        const sectionStats = {};
        questions.forEach(q => {
            if (!sectionStats[q.section]) sectionStats[q.section] = 0;
            sectionStats[q.section]++;
        });

        document.getElementById('file-analysis').classList.remove('hidden');
        document.getElementById('total-analysis-count').innerText = questions.length;
        const ul = document.getElementById('section-list');
        ul.innerHTML = '';
        Object.keys(sectionStats).forEach(sec => {
            const li = document.createElement('li');
            li.innerText = `${sec}: ${sectionStats[sec]}ë¬¸ì œ`;
            ul.appendChild(li);
        });

        document.getElementById('timer-input').value = 60;
        document.getElementById('q-count-input').value = Math.min(60, questions.length);
        alert(`ë¡œë“œ ì™„ë£Œ! ${questions.length}ë¬¸ì œ.`);
    }

    // --- Quiz Logic ---
    function generateQuizList(questions, targetCount) {
        // ì„¹ì…˜ë³„ ê· ë“± ì¶”ì¶œ ë¡œì§
        const sectionMap = new Map();
        questions.forEach(q => {
            if (!sectionMap.has(q.section)) sectionMap.set(q.section, []);
            sectionMap.get(q.section).push(q);
        });
        
        let result = [];
        const distinctSections = Array.from(sectionMap.keys());
        if (distinctSections.length === 0) return questions.slice(0, targetCount);

        const baseCount = Math.floor(targetCount / distinctSections.length);
        let remainder = targetCount % distinctSections.length;

        distinctSections.forEach(sec => {
            let count = baseCount + (remainder > 0 ? 1 : 0);
            if (remainder > 0) remainder--;
            const pool = sectionMap.get(sec);
            const picked = pool.sort(() => Math.random() - 0.5).slice(0, Math.min(count, pool.length));
            result = result.concat(picked);
        });
        
        return result.sort(() => Math.random() - 0.5); // ì „ì²´ì ìœ¼ë¡œ í•œë²ˆ ë” ì„ê¸°
    }

    function startQuiz() {
        const rawText = document.getElementById('data-input').value;
        if (!rawText.trim()) return alert("ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
        allQuestions = parseQuestions(rawText);
        
        const inputCount = parseInt(document.getElementById('q-count-input').value);
        const targetCount = (inputCount > 0) ? inputCount : allQuestions.length;
        
        quizList = generateQuizList(allQuestions, targetCount);
        
        userHistory = {};
        score = 0;
        currentIdx = 0;
        
        const mins = parseInt(document.getElementById('timer-input').value) || 60;
        timeRemaining = mins * 60;
        startTimer();

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        
        loadQuestion(0);
    }

    function loadQuestion(idx) {
        currentIdx = idx;
        const qData = quizList[idx];
        
        // UI ì´ˆê¸°í™”
        document.getElementById('q-progress').innerText = `${idx + 1} / ${quizList.length}`;
        document.getElementById('current-score').innerText = score;
        
        const badge = document.getElementById('section-badge');
        if (qData.section !== "ì¼ë°˜") { badge.innerText = qData.section; badge.classList.remove('hidden'); }
        else badge.classList.add('hidden');

        // [ê¸°ëŠ¥ 2, 3] í†µê³„ í‘œì‹œ
        const statsStore = loadStorage(STORAGE_KEY_STATS);
        const qStat = statsStore[qData.id] || { attempts: 0, lastResult: null };
        const statResultEl = document.getElementById('stat-result');
        const statCountEl = document.getElementById('stat-count');
        
        statCountEl.innerText = `ëˆ„ì  í’€ì´: ${qStat.attempts}íšŒ`;
        if(qStat.lastResult === 'correct') statResultEl.innerHTML = `ì´ì „ ê¸°ë¡: <span class="badge-correct">ì •ë‹µ O</span>`;
        else if(qStat.lastResult === 'wrong') statResultEl.innerHTML = `ì´ì „ ê¸°ë¡: <span class="badge-wrong">ì˜¤ë‹µ X</span>`;
        else statResultEl.innerText = `ì´ì „ ê¸°ë¡: ì—†ìŒ`;

        document.getElementById('q-text').innerText = `Q. ${qData.q}`;
        document.getElementById('expl-area').classList.remove('show');
        
        const optsArea = document.getElementById('options-area');
        optsArea.innerHTML = '';
        
        const isMulti = qData.aIndices.length > 1;
        document.getElementById('check-btn-area').classList.toggle('hidden', !isMulti);

        // [ê¸°ëŠ¥ 1] ì„ íƒì§€ ëœë¤ ì„ê¸° ì²˜ë¦¬
        // ì›ë³¸ ì¸ë±ìŠ¤ë¥¼ ê¸°ì–µí•˜ëŠ” ê°ì²´ ë°°ì—´ ìƒì„±
        // ì˜ˆ: [{text: "â‘  ...", orgIdx: 0}, {text: "â‘¡ ...", orgIdx: 1}]
        let optionsWithIdx = qData.o.map((text, i) => ({ text, orgIdx: i }));
        const shouldShuffle = document.getElementById('shuffle-options-check').checked;
        
        if (shouldShuffle && !userHistory[qData.id]) {
            // ì•„ì§ ì•ˆ í‘¼ ë¬¸ì œì¼ ë•Œë§Œ ì„ê¸° (ì´ë¯¸ í‘¼ ë¬¸ì œëŠ” ìƒíƒœ ìœ ì§€ë¥¼ ìœ„í•´ ìˆœì„œ ê³ ì •í•´ì•¼ í•˜ì§€ë§Œ, ì—¬ê¸°ì„  ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ ë§¤ë²ˆ ì„ë˜, ê¸°ë¡ ê°ì²´ì— ë§¤í•‘ ì •ë³´ë¥¼ ì €ì¥í•˜ëŠ”ê²Œ ë³µì¡í•˜ë¯€ë¡œ 
            // "ì´ë¯¸ í’€ì—ˆìœ¼ë©´" ì„ì§€ ì•Šê±°ë‚˜ ì €ì¥ëœ ìˆœì„œë¥¼ ì¨ì•¼ í•¨. ì—¬ê¸°ì„œëŠ” "ì´ë¯¸ í‘¼ ê²½ìš°" ê·¸ëƒ¥ ì›ë³¸ ìˆœì„œëŒ€ë¡œ ë³´ì—¬ì£¼ê±°ë‚˜ ë‹¤ì‹œ ì„ìŠµë‹ˆë‹¤.)
            // -> UXìƒ í’€ê³ ë‚˜ì„œ ë³´ê¸°ê°€ ë°”ë€Œë©´ í—·ê°ˆë¦¬ë¯€ë¡œ, userHistoryì— 'shuffledOrder'ë¥¼ ì €ì¥í•˜ëŠ”ê²Œ ì¢‹ìŒ.
            if (!qData.shuffledOrder) {
                qData.shuffledOrder = shuffleArray(optionsWithIdx);
            }
            optionsWithIdx = qData.shuffledOrder;
        } else {
            // ì„ê¸° ì˜µì…˜ ê»ê±°ë‚˜, ì¬ê²€í†  ì‹œ ë“±
             if (!qData.shuffledOrder && shouldShuffle) qData.shuffledOrder = shuffleArray(optionsWithIdx);
             if (shouldShuffle) optionsWithIdx = qData.shuffledOrder;
        }

        optionsWithIdx.forEach((optObj, visualIdx) => {
            const btn = document.createElement('div');
            btn.className = 'option-item';
            btn.innerText = optObj.text;
            // datasetì— ì›ë³¸ ì¸ë±ìŠ¤ ì €ì¥ (ì •ë‹µ ì²´í¬ìš©)
            btn.dataset.orgIdx = optObj.orgIdx;
            btn.dataset.visualIdx = visualIdx;
            
            if (userHistory[qData.id]) {
                // ì´ë¯¸ í‘¼ ë¬¸ì œ ì²˜ë¦¬
                btn.style.pointerEvents = 'none';
                const record = userHistory[qData.id];
                
                // record.selectedëŠ” visualIdxê°€ ì•„ë‹ˆë¼ orgIdx ê¸°ì¤€ì´ì–´ì•¼ ì•ˆì „í•¨.
                const isSelected = record.selectedOrgIndices.includes(optObj.orgIdx);
                const isAnswer = qData.aIndices.includes(optObj.orgIdx);

                if (isSelected) {
                    if (isAnswer) btn.classList.add('correct');
                    else btn.classList.add('wrong');
                }
                if (isAnswer && !isSelected) btn.classList.add('missed');
            } else {
                btn.onclick = () => handleOptionClick(btn, isMulti);
            }
            optsArea.appendChild(btn);
        });

        if (userHistory[qData.id]) {
            document.getElementById('expl-text').innerText = qData.e || "í•´ì„¤ ì—†ìŒ";
            document.getElementById('expl-area').classList.add('show');
            if (isMulti) document.getElementById('check-btn-area').classList.add('hidden');
        }
    }

    function handleOptionClick(btn, isMulti) {
        if (isMulti) {
            btn.classList.toggle('selected');
        } else {
            // ë‹¨ì¼ ì„ íƒ -> ì¦‰ì‹œ ì œì¶œ
            const orgIdx = parseInt(btn.dataset.orgIdx);
            finishQuestion([orgIdx]);
        }
    }

    function submitMultiAnswer() {
        const selectedBtns = document.querySelectorAll('.option-item.selected');
        if (selectedBtns.length === 0) return alert("í•˜ë‚˜ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const selectedOrgIndices = Array.from(selectedBtns).map(b => parseInt(b.dataset.orgIdx)).sort((a,b)=>a-b);
        finishQuestion(selectedOrgIndices);
    }

    function finishQuestion(selectedOrgIndices) {
        const qData = quizList[currentIdx];
        
        // ì •ë‹µ ë¹„êµ
        // ë°°ì—´ ë‚´ìš© ë¹„êµ (ì •ë ¬ëœ ìƒíƒœì—¬ì•¼ í•¨)
        const answerSorted = [...qData.aIndices].sort((a,b)=>a-b);
        const userSorted = [...selectedOrgIndices].sort((a,b)=>a-b);
        const isCorrect = JSON.stringify(answerSorted) === JSON.stringify(userSorted);

        // ì´ë²ˆ ì„¸ì…˜ ê¸°ë¡
        userHistory[qData.id] = { selectedOrgIndices: selectedOrgIndices, isCorrect: isCorrect };
        if (isCorrect) score++;

        // [ê¸°ëŠ¥ 2, 3] ì˜êµ¬ ìŠ¤í† ë¦¬ì§€ ì—…ë°ì´íŠ¸
        const statsStore = loadStorage(STORAGE_KEY_STATS);
        if (!statsStore[qData.id]) statsStore[qData.id] = { attempts: 0, lastResult: null };
        
        statsStore[qData.id].attempts += 1;
        statsStore[qData.id].lastResult = isCorrect ? 'correct' : 'wrong';
        saveStorage(STORAGE_KEY_STATS, statsStore);

        // UI ê°±ì‹  (í˜„ì¬ í™”ë©´)
        // í†µê³„ ì¦‰ì‹œ ë°˜ì˜
        document.getElementById('stat-count').innerText = `ëˆ„ì  í’€ì´: ${statsStore[qData.id].attempts}íšŒ`;
        const statResultEl = document.getElementById('stat-result');
        if(isCorrect) statResultEl.innerHTML = `ê²°ê³¼: <span class="badge-correct">ì •ë‹µ O</span>`;
        else statResultEl.innerHTML = `ê²°ê³¼: <span class="badge-wrong">ì˜¤ë‹µ X</span>`;

        // ë³´ê¸° ìŠ¤íƒ€ì¼ ì ìš©
        const buttons = document.querySelectorAll('.option-item');
        buttons.forEach(btn => {
            btn.style.pointerEvents = 'none';
            btn.classList.remove('selected');
            const oIdx = parseInt(btn.dataset.orgIdx);
            
            const isSelected = selectedOrgIndices.includes(oIdx);
            const isAnswer = qData.aIndices.includes(oIdx);

            if (isSelected) {
                if (isAnswer) btn.classList.add('correct');
                else btn.classList.add('wrong');
            }
            if (isAnswer && !isSelected) btn.classList.add('missed');
        });

        document.getElementById('current-score').innerText = score;
        document.getElementById('expl-text').innerText = qData.e || "í•´ì„¤ ì—†ìŒ";
        document.getElementById('expl-area').classList.add('show');
        document.getElementById('check-btn-area').classList.add('hidden');
    }

    function finishQuiz() {
        clearInterval(timerInterval);
        const total = quizList.length;
        const finalScore = Math.round((score / total) * 100) || 0;
        const isPass = finalScore >= 60; // 60ì  í•©ê²© ê¸°ì¤€

        // [ê¸°ëŠ¥ 4] ì‹œí—˜ ê²°ê³¼ ì €ì¥
        const examLog = loadStorage(STORAGE_KEY_EXAMS);
        examLog.push({
            date: new Date().toLocaleString(),
            score: finalScore,
            totalQ: total,
            correctQ: score,
            isPass: isPass
        });
        saveStorage(STORAGE_KEY_EXAMS, examLog);

        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('hidden');
        
        document.getElementById('final-score').innerText = finalScore;
        document.getElementById('total-q-count').innerText = total;
        document.getElementById('correct-count').innerText = score;
        
        const badge = document.getElementById('pass-fail-badge');
        badge.innerText = isPass ? "ğŸ‰ í•©ê²©" : "ğŸ˜¢ ë¶ˆí•©ê²©";
        badge.className = `result-badge ${isPass ? 'pass' : 'fail'}`;

        const retryBtn = document.getElementById('btn-retry-wrong');
        retryBtn.style.display = (total - score > 0) ? 'inline-block' : 'none';
    }

    function retryWrong() {
        // í‹€ë¦° ë¬¸ì œë§Œ ì¶”ë ¤ì„œ ë‹¤ì‹œ ì‹œì‘
        const wrongQs = quizList.filter(q => userHistory[q.id] && !userHistory[q.id].isCorrect);
        if (wrongQs.length === 0) return alert("ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤.");

        quizList = wrongQs;
        // userHistoryëŠ” ì´ˆê¸°í™”í•˜ë˜, shuffledOrderëŠ” ìœ ì§€í• ì§€ ê²°ì •. 
        // ì—¬ê¸°ì„  ì´ˆê¸°í™”í•´ì„œ ë‹¤ì‹œ í’€ê²Œ í•¨.
        userHistory = {};
        quizList.forEach(q => q.shuffledOrder = null); // ë‹¤ì‹œ ì„ê¸° ìœ„í•´

        score = 0;
        currentIdx = 0;

        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('quiz-screen').classList.remove('hidden');
        loadQuestion(0);
    }

    // --- History View ---
    function showExamHistory() {
        const logs = loadStorage(STORAGE_KEY_EXAMS);
        const list = document.getElementById('exam-log-list');
        list.innerHTML = '';
        
        if (logs.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#999;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            // ìµœì‹ ìˆœ ì •ë ¬
            [...logs].reverse().forEach((log, i) => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div>
                        <span style="font-weight:bold; color:${log.isPass ? 'var(--primary)' : 'var(--danger)'}">
                            ${log.isPass ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'}
                        </span>
                        <span style="margin-left:5px; color:#555;">${log.date}</span>
                    </div>
                    <div>
                        <b>${log.score}ì </b> (${log.correctQ}/${log.totalQ})
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('history-screen').classList.remove('hidden');
    }

    function closeExamHistory() {
        document.getElementById('history-screen').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
    }

    function clearAllData() {
        if(confirm("ëª¨ë“  ë¬¸ì œ í’€ì´ ì´ë ¥ê³¼ ì‹œí—˜ ê¸°ë¡ì„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem(STORAGE_KEY_STATS);
            localStorage.removeItem(STORAGE_KEY_EXAMS);
            alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            location.reload();
        }
    }

    // --- Timer & Nav ---
    function startTimer() {
        clearInterval(timerInterval);
        isPaused = false;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            if (!isPaused) {
                timeRemaining--;
                updateTimerDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    alert("ì‹œê°„ ì¢…ë£Œ!");
                    finishQuiz();
                }
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const m = Math.floor(timeRemaining / 60);
        const s = timeRemaining % 60;
        document.getElementById('timer-display').innerText = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function togglePause() { isPaused = !isPaused; document.getElementById('btn-pause').innerText = isPaused ? "ê³„ì†" : "ì¼ì‹œì •ì§€"; document.getElementById('q-container').style.opacity = isPaused ? '0.2' : '1'; document.getElementById('q-container').style.pointerEvents = isPaused ? 'none' : 'auto'; }
    function nextQ() { if (currentIdx < quizList.length - 1) loadQuestion(currentIdx + 1); else if(confirm("ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) finishQuiz(); }
    function prevQ() { if (currentIdx > 0) loadQuestion(currentIdx - 1); }
</script>
</body>
</html>
