using HHI.Deployment.Client.Properties;
using System;
using System.ComponentModel;
using System.Diagnostics;
using System.Drawing;
using System.IO;
using System.Windows.Forms;

#nullable disable
namespace HHI.Deployment.Client;

/// <summary>업데이트 폼입니다.</summary>
public class UpdaterForm : Form, IDeployUpdateEvent
{
  private string _sourceName = (string) null;
  private string _logFileName = (string) null;
  /// <summary>Required designer variable.</summary>
  private IContainer components = (IContainer) null;
  private Panel panel1;
  private Panel panel2;
  private Panel panel3;
  private Label lblDescription;
  private Label lblTitle;
  private Button btnViewLog;
  private Label label4;
  private Label label3;
  private Label lblMessage;
  private ProgressBar progressBar1;
  private Label lblSource;
  private Label lblName;
  private Panel panel4;
  private Panel panel5;
  private Button btnClose;
  private PictureBox pbxError;
  internal DeployUpdateSettings Settings { get; private set; }

  /// <summary>
  /// 
  /// </summary>
  public bool Success { get; private set; }

  /// <summary>UpdaterForm 클래스의 새 인스턴스를 초기화합니다.</summary>
  /// <param name="settings"></param>
  public UpdaterForm(DeployUpdateSettings settings)
  {
    this.Success = false;
    if (settings == null)
      throw new ArgumentNullException(nameof (settings));
    if (settings.DownloadServerUrl == null)
      throw new ArgumentNullException("settings.DownloadUrl");
    this.Settings = settings.LauncherName != null ? settings : throw new ArgumentNullException("settings.LauncherName");
    this.InitializeComponent();
    ResLang.SetResource(settings.LanguageName);
    this._sourceName = Path.GetFileNameWithoutExtension(settings.LauncherName);
    this.Text = $"{ResLang.Installing} - {this._sourceName}";
    this.lblTitle.Text = $"{ResLang.Installing} - {this._sourceName}";
    this.lblName.Text = this._sourceName;
    this.lblSource.Text = settings.DownloadServerUrl;
    this.lblDescription.Text = ResLang.Description;
    this.btnViewLog.Text = ResLang.ViewLog;
    this.btnClose.Text = ResLang.Close;
    this.label3.Text = ResLang.Name;
    this.label4.Text = ResLang.From;
  }

  private void UpdaterForm_Shown(object sender, EventArgs e)
  {
    new DeployUpdateController((IDeployUpdateEvent) this, this.Settings).UpdateAsync();
  }

  private void controller_Error(object sender, FxUpdateErrorEventArgs e)
  {
    this.pbxError.Image = (Image) Resources.msg_error;
    this.pbxError.Visible = true;
    this.lblTitle.Text = ResLang.RaiseError;
    this.lblDescription.Text = e.Exception.Message;
    this.lblMessage.Text = "";
    this._logFileName = e.LogFileName;
    this.btnViewLog.Enabled = true;
    this.btnClose.Enabled = true;
    int num = (int) MessageBox.Show((IWin32Window) this, e.Exception.Message, "Error", MessageBoxButtons.OK, MessageBoxIcon.Hand);
  }

  private void controller_Completed(object sender, DeployUpdateEventArgs e)
  {
    this.btnClose.Enabled = true;
    this.Success = true;
    this.Close();
  }
  internal void ShowMessage(string message, string titlePrefix)
  {
    this.lblMessage.Text = message;
    this.Text = $"{titlePrefix}{ResLang.Installing} - {this._sourceName}";
  }

  internal void ShowMessage(
    string message,
    string titlePrefix,
    double maxValue,
    double currentValue)
  {
    this.ShowMessage(message, titlePrefix);
    this.progressBar1.Maximum = (int) maxValue;
    this.progressBar1.Value = (int) currentValue;
  }

  private void btnClose_Click(object sender, EventArgs e) => this.Close();

  private void btnViewLog_Click(object sender, EventArgs e)
  {
    if (string.IsNullOrEmpty(this._logFileName) || !File.Exists(this._logFileName))
      return;
    Process.Start("notepad.exe", this._logFileName);
  }

  void IDeployUpdateEvent.OnShowDialog(object sender, DeployUpdateEventArgs e)
  {
  }
  void IDeployUpdateEvent.OnCompleted(object sender, DeployUpdateEventArgs e)
  {
    this.BeginInvoke((Delegate) (() => this.controller_Completed(sender, e)));
  }

  void IDeployUpdateEvent.OnError(object sender, FxUpdateErrorEventArgs e)
  {
    this.BeginInvoke((Delegate) (() => this.controller_Error(sender, e)));
  }

  void IDeployUpdateEvent.ShowMessage(string message, string titlePrefix)
  {
    if (this.InvokeRequired)
      this.BeginInvoke((Delegate) (() => this.ShowMessage(message, titlePrefix)));
    else
      this.ShowMessage(message, titlePrefix);
  }

  void IDeployUpdateEvent.ShowMessage(
    string message,
    string titlePrefix,
    double maxValue,
    double currentValue)
  {
    if (this.InvokeRequired)
      this.BeginInvoke((Delegate) (() => this.ShowMessage(message, titlePrefix, maxValue, currentValue)));
    else
      this.ShowMessage(message, titlePrefix, maxValue, currentValue);
  }
  void IDeployUpdateEvent.OnUpdate(object sender, FxDeployUpdateListEventArgs e)
  {
  }

  /// <summary>Clean up any resources being used.</summary>
  /// <param name="disposing">true if managed resources should be disposed; otherwise, false.</param>
  protected override void Dispose(bool disposing)
  {
    if (disposing && this.components != null)
      this.components.Dispose();
    base.Dispose(disposing);
  }

  /// <summary>
  /// Required method for Designer support - do not modify
  /// the contents of this method with the code editor.
  /// </summary>
  private void InitializeComponent()
  {
    ComponentResourceManager componentResourceManager = new ComponentResourceManager(typeof (UpdaterForm));
    this.panel1 = new Panel();
    this.lblDescription = new Label();
    this.lblTitle = new Label();
    this.panel2 = new Panel();
    this.btnClose = new Button();
    this.btnViewLog = new Button();
    this.panel3 = new Panel();
    this.lblSource = new Label();
    this.lblName = new Label();
    this.label4 = new Label();
    this.label3 = new Label();
    this.lblMessage = new Label();
    this.progressBar1 = new ProgressBar();
    this.panel4 = new Panel();
    this.panel5 = new Panel();
    this.pbxError = new PictureBox();
    this.panel1.SuspendLayout();
    this.panel2.SuspendLayout();
    this.panel3.SuspendLayout();
    ((ISupportInitialize) this.pbxError).BeginInit();
    this.SuspendLayout();
    this.panel1.BackColor = Color.White;
    this.panel1.Controls.Add((Control) this.pbxError);
    this.panel1.Controls.Add((Control) this.lblDescription);
    this.panel1.Controls.Add((Control) this.lblTitle);
    this.panel1.Dock = DockStyle.Top;
    this.panel1.Location = new Point(1, 1);
    this.panel1.Margin = new Padding(3, 2, 3, 2);
    this.panel1.Name = "panel1";
    this.panel1.Size = new Size(466, 67);
    this.panel1.TabIndex = 0;
    this.lblDescription.Location = new Point(62, 33);
    this.lblDescription.Name = "lblDescription";
    this.lblDescription.Size = new Size(393, 33);
    this.lblDescription.TabIndex = 1;
    this.lblDescription.Text = "This may take several minutes. You can use your computer to do other tasks during the installation.";
    this.lblTitle.AutoSize = true;
    this.lblTitle.Font = new Font("Gulim", 9f, FontStyle.Bold, GraphicsUnit.Point, (byte) 129);
    this.lblTitle.Location = new Point(12, 12);
    this.lblTitle.Name = "lblTitle";
    this.lblTitle.Size = new Size(65, 12);
    this.lblTitle.TabIndex = 0;
    this.lblTitle.Text = "Installing";
    this.panel2.BackColor = Color.White;
    this.panel2.Controls.Add((Control) this.btnClose);
    this.panel2.Controls.Add((Control) this.btnViewLog);
    this.panel2.Dock = DockStyle.Bottom;
    this.panel2.Location = new Point(1, 188);
    this.panel2.Margin = new Padding(3, 2, 3, 2);
    this.panel2.Name = "panel2";
    this.panel2.Size = new Size(466, 48 /*0x30*/);
    this.panel2.TabIndex = 1;
    this.btnClose.Enabled = false;
    this.btnClose.Location = new Point(368, 13);
    this.btnClose.Margin = new Padding(3, 2, 3, 2);
    this.btnClose.Name = "btnClose";
    this.btnClose.Size = new Size(87, 23);
    this.btnClose.TabIndex = 1;
    this.btnClose.Text = "Close";
    this.btnClose.UseVisualStyleBackColor = true;
    this.btnClose.Click += new EventHandler(this.btnClose_Click);
    this.btnViewLog.Enabled = false;
    this.btnViewLog.Location = new Point(12, 13);
    this.btnViewLog.Margin = new Padding(3, 2, 3, 2);
    this.btnViewLog.Name = "btnViewLog";
    this.btnViewLog.Size = new Size(87, 23);
    this.btnViewLog.TabIndex = 0;
    this.btnViewLog.Text = "View Log...";
    this.btnViewLog.UseVisualStyleBackColor = true;
    this.btnViewLog.Click += new EventHandler(this.btnViewLog_Click);
    this.panel3.BackColor = Color.White;
    this.panel3.Controls.Add((Control) this.lblSource);
    this.panel3.Controls.Add((Control) this.lblName);
    this.panel3.Controls.Add((Control) this.label4);
    this.panel3.Controls.Add((Control) this.label3);
    this.panel3.Controls.Add((Control) this.lblMessage);
    this.panel3.Controls.Add((Control) this.progressBar1);
    this.panel3.Dock = DockStyle.Fill;
    this.panel3.Location = new Point(1, 68);
    this.panel3.Margin = new Padding(3, 2, 3, 2);
    this.panel3.Name = "panel3";
    this.panel3.Size = new Size(466, 120);
    this.panel3.TabIndex = 2;
    this.lblSource.AutoSize = true;
    this.lblSource.Font = new Font("Gulim", 9f, FontStyle.Bold, GraphicsUnit.Point, (byte) 129);
    this.lblSource.Location = new Point(60, 37);
    this.lblSource.Name = "lblSource";
    this.lblSource.Size = new Size(63 /*0x3F*/, 12);
    this.lblSource.TabIndex = 5;
    this.lblSource.Text = "hhi.co.kr";
    this.lblName.AutoSize = true;
    this.lblName.Font = new Font("Gulim", 9f, FontStyle.Bold, GraphicsUnit.Point, (byte) 129);
    this.lblName.Location = new Point(60, 16 /*0x10*/);
    this.lblName.Name = "lblName";
    this.lblName.Size = new Size(66, 12);
    this.lblName.TabIndex = 4;
    this.lblName.Text = "Launcher";
    this.label4.AutoSize = true;
    this.label4.Location = new Point(12, 37);
    this.label4.Name = "label4";
    this.label4.Size = new Size(38, 12);
    this.label4.TabIndex = 3;
    this.label4.Text = "From:";
    this.label3.AutoSize = true;
    this.label3.Location = new Point(12, 16 /*0x10*/);
    this.label3.Name = "label3";
    this.label3.Size = new Size(43, 12);
    this.label3.TabIndex = 2;
    this.label3.Text = "Name:";
    this.lblMessage.AutoSize = true;
    this.lblMessage.Location = new Point(12, 91);
    this.lblMessage.Name = "lblMessage";
    this.lblMessage.Size = new Size(113, 12);
    this.lblMessage.TabIndex = 1;
    this.lblMessage.Text = "Check for update...";
    this.progressBar1.Location = new Point(14, 62);
    this.progressBar1.Margin = new Padding(3, 2, 3, 2);
    this.progressBar1.Name = "progressBar1";
    this.progressBar1.Size = new Size(441, 18);
    this.progressBar1.TabIndex = 0;
    this.panel4.Dock = DockStyle.Top;
    this.panel4.Location = new Point(1, 68);
    this.panel4.Margin = new Padding(3, 2, 3, 2);
    this.panel4.Name = "panel4";
    this.panel4.Size = new Size(466, 1);
    this.panel4.TabIndex = 2;
    this.panel5.Dock = DockStyle.Bottom;
    this.panel5.Location = new Point(1, 187);
    this.panel5.Margin = new Padding(3, 2, 3, 2);
    this.panel5.Name = "panel5";
    this.panel5.Size = new Size(466, 1);
    this.panel5.TabIndex = 0;
    this.pbxError.Image = (Image) Resources.msg_info;
    this.pbxError.Location = new Point(15, 28);
    this.pbxError.Margin = new Padding(3, 2, 3, 2);
    this.pbxError.Name = "pbxError";
    this.pbxError.Size = new Size(32 /*0x20*/, 32 /*0x20*/);
    this.pbxError.SizeMode = PictureBoxSizeMode.AutoSize;
    this.pbxError.TabIndex = 2;
    this.pbxError.TabStop = false;
    this.AutoScaleDimensions = new SizeF(7f, 12f);
    this.AutoScaleMode = AutoScaleMode.Font;
    this.BackColor = SystemColors.ControlDarkDark;
    this.ClientSize = new Size(468, 237);
    this.ControlBox = false;
    this.Controls.Add((Control) this.panel4);
    this.Controls.Add((Control) this.panel5);
    this.Controls.Add((Control) this.panel3);
    this.Controls.Add((Control) this.panel1);
    this.Controls.Add((Control) this.panel2);
    this.Cursor = Cursors.Default;
    this.FormBorderStyle = FormBorderStyle.None;
    this.Icon = (Icon) componentResourceManager.GetObject("$this.Icon");
    this.Margin = new Padding(3, 2, 3, 2);
    this.MaximizeBox = false;
    this.Name = nameof (UpdaterForm);
    this.Padding = new Padding(1);
    this.StartPosition = FormStartPosition.CenterScreen;
    this.Text = "(0%) Installing";
    this.Shown += new EventHandler(this.UpdaterForm_Shown);
    this.panel1.ResumeLayout(false);
    this.panel1.PerformLayout();
    this.panel2.ResumeLayout(false);
    this.panel3.ResumeLayout(false);
    this.panel3.PerformLayout();
    ((ISupportInitialize) this.pbxError).EndInit();
    this.ResumeLayout(false);
  }
}

