namespace Amisys.Framework.Presentation.AmiMainShell.Views
{
[Export(typeof(Shell))]
public partial class Shell : UserControl, INotifyPropertyChanged
{
... (생략) ...

public static bool LoadViewList(string workspaceName, out List<ModuleViewId> moduleViews)
{
	moduleViews = new List<ModuleViewId>();

	try
	{
		AmiWorkspaceHelper.Load(workspaceName, moduleViews);
	}
	catch (Exception)
	{
		return false;
	}

	return (moduleViews.Count > 0);
}

public static bool LoadDockLayout(AmiViewList workspace)
{
	if (workspace != null)
	{
		string tmpWorkspaceName = EnsureProperWorkspaceName(workspace);
		string path;
		string filename;
		GetSafeWorkspaceLayoutFilename(tmpWorkspaceName, out path, out filename);

		if (DockManager != null)
		{
			try
			{
				if (AmiFileUtility.IsExistFile(filename))
				{
					// restore layout
					AmiFileUtility.ReleseLockedFile(filename);
					DockManager.RestoreLayoutFromXml(filename);

					return true;
				}
			}
			catch (Exception)
			{
			}
		}
	}

	return false;
}

private void SaveLayout(string workspaceName)
{
    string path;
    string filename;
    GetSafeWorkspaceLayoutFilename(workspaceName, out path, out filename);

    try
    {
        AmiFileUtility.ForceCreateDirectory(path);
        AmiFileUtility.ForceDeleteFile(filename);

        // Layout 그룹의 Tag에 ViewName을 기록하고
        // Restore 시에 해동 ViewName을 가지는 그룹에 뷰를 붙임
        SetLayoutViewList();
                
        dockManager.SaveLayoutToXml(filename);
    }
    catch (Exception ex)
    {
        string msg = string.Format("[{0}]Layout을 저장할 수 없습니다.", workspaceName);
        logger.Write(msg);
        logger.Write(ex.ToString());
    }
}

private void SaveDockLayout(string workspaceName)
{
	string tmpWorkspaceName = EnsureWorkspaceName(workspaceName);

	// layout
	SaveLayout(tmpWorkspaceName);

	// view 목록
	SaveViewList(tmpWorkspaceName);
}

public void GetActiveModuleAndViewList(out List<ModuleViewId> moduleViews)
{
	moduleViews = new List<ModuleViewId>();

	foreach (IPanelInfo view in regionManager.Regions[MefRegionDefinition.MainRegion].ActiveViews)
	{
		var moduleView = new ModuleViewId()
		{
			ModuleName = view.GetModuleName(),
			ViewName = view.GetViewName(),
			NodeName = view.GetViewName(),
			Id = view.GetId()
		};
		moduleViews.Add(moduleView);
	}
}

private void OpenWorkspace(string workspaceName, AmiViewList amiViewList = null)
{
	BeginWaitCursor();
	RemoveFixedBar();
	// read module list
	List<ModuleViewId> viewList;
	if (LoadViewList(workspaceName, out viewList) == true)
	{
		// 이전에 저장된 모듈 목록이 없다면, 메뉴에 등록된 모듈을 이용
		// ViewIdList로 로드
		foreach (var view in viewList)
		{
			LoadModuleWithViewName(view.ModuleName, view.ViewName, view.Id);
		}		
	}
	else
	{
		// AmiViewList로 로드
		// load modules
		foreach (var view in amiViewList)
		{                    
			LoadModule(view);
		}		
	}

	// restore dock layout
	if (LoadDockLayout(workspaceName) == false)
	{
	}
	dockManager.MDIMergeStyle = _CurrentMergeStyle;

	if (viewList != null && viewList.Count > 0)
	{
		// 1. 기존 방식: Caption(NodeName)으로 찾기
		string caption = viewList[0].NodeName;
		BaseLayoutItem item = recv_GetLayoutitem(dockManager.LayoutRoot, caption);

		// 2. Fallback: Caption으로 못 찾았을 경우, Name으로 다시 찾기
		if (item == null)
		{
			string viewName = viewList[0].ViewName;

			if (!string.IsNullOrEmpty(viewName) && viewName.Contains(","))
			{
				string typeName = viewName.Split(',')[0]; // 콤마 앞의 전체 타입명 추출
				string[] parts = typeName.Split('.');     // 점으로 분리
				viewName = parts[parts.Length - 1];       // 마지막 부분이 클래스 이름
			}

			string name = string.Format("{0}:{1}", viewList[0].ModuleName, viewName);
			item = recv_GetLayoutitemByName(dockManager.LayoutRoot, name);
		}

		// item을 찾았으면 활성화
		if (item != null)
		{
			SetActivePannel(item);
		}
	}
	else if (amiViewList != null && amiViewList.Count > 0)
	{
		DataRow row = amiViewList[0];
		string caption = row.Field<string>("NodeName");
		BaseLayoutItem item = recv_GetLayoutitem(dockManager.LayoutRoot, caption);
		SetActivePannel(item);
	}

	// start workspace 
	StartWorkspaceProfile(CurrentWorkspaceId, CurrentWorkspaceName);

	EndWaitCursor();
}

private BaseLayoutItem recv_GetLayoutitemByName(DevExpress.Xpf.Docking.LayoutGroup group, string name)
{
	if (group == null) return null;

	foreach (BaseLayoutItem child in group.Items)
	{
		if (child is DevExpress.Xpf.Docking.LayoutGroup)
		{
			// 그룹인 경우 재귀 호출
			BaseLayoutItem item = recv_GetLayoutitemByName((DevExpress.Xpf.Docking.LayoutGroup)child, name);
			if (item != null) return item;
		}
		else if (child.Name == name) // Name 속성 비교
		{
			return child;
		}
	}
	return null;
}

private void RemoveFixedBar()
{
	List<Bar> deleteBars = new List<Bar>();
	foreach (var bar in parentBarManager.Bars)
	{
		if (bar.Name.StartsWith("fixedBar"))
		{
			if (GetRowNumInBar(bar) >= 0)
			{
				bar.UnMerge();
				deleteBars.Add(bar);
			}
		}
	}
	foreach (var bar in deleteBars)
	{
		parentBarManager.Bars.Remove(bar);
	}
	_FixedBarParents.Clear();
}
private bool LoadViewList(string workspaceName, out List<ModuleViewId> moduleViews)
{
	moduleViews = new List<ModuleViewId>();

	try
	{
		AmiWorkspaceHelper.Load(workspaceName, moduleViews);
	}
	catch (Exception)
	{
		return false;
	}

	return (moduleViews.Count > 0);
}

private void LoadModuleWithViewName(string moduleName, string viewName, int id = 0)
{
	if (this.moduleManager == null) return;

	AddCatalog(moduleName);

	ModuleInfo isLoadedMod = IsContainsModule(moduleName);
	if (isLoadedMod != null)
	{
		if (isLoadedMod.State == ModuleState.NotStarted)
			this.moduleManager.LoadModule(moduleName);

		// set Current View Id
		amiDataService.CurrentId = id;

		PubLoadModule(moduleName, viewName, id);

		// clear current view Id
		amiDataService.CurrentId = -1;
	}
}

public void LoadModule(DataRow row)
{
	if (this.moduleManager != null && row != null)
	{
		int id = row.Field<int>("NodeId");
		string moduleName = row.Field<string>("AssemblyName");
		string viewName = row.Field<string>("ViewName");

		AddCatalog(moduleName);

		ModuleInfo isLoadedMod = IsContainsModule(moduleName);
		if (isLoadedMod != null)
		{
			if (isLoadedMod.State == ModuleState.NotStarted)
				this.moduleManager.LoadModule(moduleName);

			// set Current View Id
			amiDataService.CurrentId = id;

			// Load Module
			PubLoadModule(moduleName, viewName, id);

			// clear current view Id
			amiDataService.CurrentId = -1;
		}
	}
}

private bool LoadDockLayout(string workspaceName)
{
	string tmpWorkspaceName = EnsureWorkspaceName(workspaceName);
	string path;
	string filename;
	GetSafeWorkspaceLayoutFilename(tmpWorkspaceName, out path, out filename);

	try
	{
		if (AmiFileUtility.IsExistFile(filename))
		{
			// restore layout
			AmiFileUtility.ReleseLockedFile(filename);
			dockManager.RestoreLayoutFromXml(filename);
		}
		else
		{
			return false;
		}
	}
	catch (Exception)
	{
		return false;
	}

	return true;
}

private BaseLayoutItem recv_GetLayoutitem(DevExpress.Xpf.Docking.LayoutGroup group, string caption)
{
	if (group == null) return null;
	foreach (BaseLayoutItem child in group.Items)
	{
		if (child is DevExpress.Xpf.Docking.LayoutGroup)
		{
			BaseLayoutItem item = recv_GetLayoutitem((DevExpress.Xpf.Docking.LayoutGroup)child, caption);
			if (item != null) return item;
		}
		else if ((child.Caption as string) == caption) return child;
	}
	return null;
}

private void SetActivePannel(BaseLayoutItem pannel)
{
	if (pannel != null)
	{
		dockManager.Activate(pannel);
	}
}

private void StartWorkspaceProfile(int id, string name)
{
	if (WorkspaceUsingProfile != null)
		WorkspaceUsingProfile.Begin(CurrentWorkspaceId, CurrentWorkspaceName);
}
}



