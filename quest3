using DevExpress.Xpf.Docking;
using Microsoft.Practices.Prism.Regions;
using System.Collections;
using System.Collections.ObjectModel;
using System.Collections.Specialized;
using System.ComponentModel.Composition;

namespace Amisys.Framework.Infrastructure.RegionAdapters
{
    [PartCreationPolicy(CreationPolicy.NonShared)]
    [Export(typeof(LayoutGroupAdapter))]
    //[method: ImportingConstructor]
    public class LayoutGroupAdapter(IRegionBehaviorFactory behaviorFactory) : RegionAdapterBase<LayoutGroup>(behaviorFactory)
    {
        protected virtual IRegion CreateRegion() => (IRegion)new AllActiveRegion();

        protected virtual void Adapt(IRegion region, LayoutGroup regionTarget)
        {
            ((INotifyCollectionChanged)region.Views).CollectionChanged += (NotifyCollectionChangedEventHandler)((s, e) => this.OnViewsCollectionChanged(region, regionTarget, s, e));
        }

        private void OnViewsCollectionChanged(
          IRegion region,
          LayoutGroup regionTarget,
          object sender,
          NotifyCollectionChangedEventArgs e)
        {
            if (e.Action != NotifyCollectionChangedAction.Add)
                return;
            foreach (object newItem in (IEnumerable)e.NewItems)
            {
                LayoutPanel layoutPanel = new LayoutPanel();
                ((ContentItem)layoutPanel).Content = newItem;
                if (newItem is IPanelInfo)
                {
                    ((BaseLayoutItem)layoutPanel).Name = ((IPanelInfo)newItem).GetPanelName();
                    ((BaseLayoutItem)layoutPanel).Caption = (object)((IPanelInfo)newItem).GetPanelCaption();
                }
                else
                    ((BaseLayoutItem)layoutPanel).Caption = (object)"new Page";
                ((Collection<BaseLayoutItem>)regionTarget.Items).Add((BaseLayoutItem)layoutPanel);
                regionTarget.SelectedTabIndex = ((Collection<BaseLayoutItem>)regionTarget.Items).Count - 1;
            }
        }
    }
}
